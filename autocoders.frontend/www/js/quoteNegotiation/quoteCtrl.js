/**
 * Created by vamshi on 10/13/15.
 */
angular.module('starter')
.controller('quoteCtrl', [ '$scope','$stateParams','quoteService', 'quoteApiProxy', 'userApiProxy','pushNotificationService', '$state',
	function($scope, $stateParams, quoteService, quoteApiProxy, userApiProxy, pushNotificationService, $state) {
		$scope.view = {};
		$scope.vehicle = $stateParams.vehicle;
		$scope.creditTiers = ["700+", "660-699", "620-659", "600-619"];
		$scope.sellerQuote = {};
		$scope.buyerQuoteOffer = {};
		var self = this;
		
		self.setPaymentOnQuote = function(quote, paymentInfo){
			quote.featPrice = $scope.vehicle.featPrice;
			quote.titleFee =  paymentInfo.titleFee;
			quote.regFee = paymentInfo.registrationFee;
			quote.term = 60;
			quote.creditTier = quote.creditTier;
			quote.apr = 1.99;
			quote.taxRate = paymentInfo.taxRate;
			quote.monthlyPayment = paymentInfo.monthlyPayment;
		};
		
		self.AddQuote = function(){
			quoteApiProxy.addQuote($scope.buyerQuoteOffer, $scope.sellerQuote, $scope.vehicle, $scope.buyer, $scope.vehicle.accountKey)
				.then(function(finalQuote){
					$scope.finalQuote = finalQuote.data;
					$scope.view.editable = false;
					var message ={
						message:"Message from Autocoders",
						title:"Hello! A proposal has been generated by " + $scope.buyer.name +" for "
						+$scope.vehicle.year+" " +$scope.vehicle.make+" " +$scope.vehicle.model+" "
						+$scope.vehicle.trim + ".",
						quoteId:$scope.finalQuote.id,
						type:"Negotiating"
					};
					pushNotificationService.sendNotification($scope.vehicle.accountKey,message);
					$state.go("app.quoteSubmitted");
				});
		};
		
		$scope.AcceptQuote = function(){
			$scope.buyerQuoteOffer = $scope.sellerQuote;
			self.AddQuote();
		};
		
		$scope.CalcPayment = function(){
			//Request payments
			quoteService.getQuote($scope.buyerQuoteOffer.offerPrice, $scope.buyerQuoteOffer.term, $scope.buyerQuoteOffer.tradeInValue, $scope.buyerQuoteOffer.downPayment, $scope.zipCode).then(
				function(payment){
					self.setPaymentOnQuote($scope.buyerQuoteOffer, payment);
				},
				function(){
					$scope.Error = "Error fetching quote. Please retry.";
				}
			);
		};
		
		$scope.MakeOffer = function() {
			//Submit Offer
			if($scope.view.offerStatus === "SUBMIT OFFER"){
				//Insert if id is null/undefined, else, update the finalQuote
				$scope.sellerQuote.offerPrice = $scope.buyerQuoteOffer.offerPrice;
				if($scope.finalQuote && $scope.finalQuote.id){
					quoteApiProxy.updateQuote($scope.finalQuote.id, $scope.buyerQuoteOffer, $scope.sellerQuote, $scope.vehicle, $scope.buyer, $scope.vehicle.accountKey)
						.then(function(finalQuote){
							$scope.finalQuote = finalQuote.data;
							var message ={
								message:"Message from Autocoders",
								title:"Hello! A proposal has been generated by " + $scope.buyer.name +" for "
								+$scope.vehicle.year+" " +$scope.vehicle.make+" " +$scope.vehicle.model+" "
								+$scope.vehicle.trim + ".",
								quoteId:$scope.finalQuote.id,
								type:"Negotiating"
							};
							pushNotificationService.sendNotification($scope.vehicle.accountKey,message);
							$state.go("app.quoteSubmitted");
						});	
				}else{
					self.AddQuote();
				}
				$scope.view.offerStatus = "MAKE OFFER";
			}else{//MAKE OFFER
				$scope.view.editable = true;
				$scope.buyerQuoteOffer = angular.copy($scope.sellerQuote);//Make a deep copy of sellerQuote first time
				$scope.view.quote = $scope.buyerQuoteOffer;
				$scope.view.offerStatus = "SUBMIT OFFER";
			}
		};
		
		//Init
		(function(){
			//Set Defaults
			$scope.sellerQuote.term = 60;
			$scope.sellerQuote.creditTier = "700+";
			$scope.sellerQuote.tradeInValue = 0;
			$scope.sellerQuote.downPayment = 0;
			$scope.buyerQuoteOffer.offerPrice = $scope.vehicle.featPrice;
			$scope.buyerQuoteOffer.tradeInValue = 0;
			$scope.buyerQuoteOffer.downPayment = 0;
			$scope.buyerQuoteOffer.creditTier = "700+";
			if(!$scope.zipCode){
				$scope.zipCode = '60107';
			}
			userApiProxy.getUsers("(accountKey eq '"+ userApiProxy.getCurrentUser().accountKey + "')").then(function(user){
				$scope.buyer = user.data[0];
			});
			
			//Request payments
			quoteService.getQuote($scope.vehicle.featPrice, $scope.sellerQuote.term, $scope.sellerQuote.tradeInValue, $scope.sellerQuote.downPayment, $scope.zipCode).then(
				function(payment){
					$scope.view.editable = false;
					$scope.view.offerStatus = "MAKE OFFER";
					self.setPaymentOnQuote($scope.sellerQuote, payment);
					$scope.view.quote = $scope.sellerQuote;
				},
				function(){
					$scope.Error = "Error fetching quote. Please retry.";
				}
			);
		})();
	}]);